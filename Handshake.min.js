var Basic=Basic||{};Basic.version="0.0.1";var Native=Array.prototype;Basic.Array={};Basic.Array.indexOf=Native.indexOf?function(b,e){return Native.indexOf.call(b,e)}:function(b,e){for(var a=0;a<b.length;a+=1)if(b[a]===e)return a;return-1};
(function(){var b=false,e=/xyz/.test(function(){})?/\bsuperclass\b/:/.*/;Basic.Class=function(){};Basic.Class.extend=function(a){function d(){!b&&this.init&&this.init.apply(this,arguments)}var g=this.prototype;b=true;var h=new this;b=false;for(var c in a)h[c]=typeof a[c]=="function"&&typeof g[c]=="function"&&e.test(a[c])?function(f,i){return function(){var j=this.superclass;this.superclass=g[f];var k=i.apply(this,arguments);this.superclass=j;return k}}(c,a[c]):a[c];d.prototype=h;d.constructor=d;d.extend=
arguments.callee;d.augment=function(f){for(methodName in f.prototype)this.prototype[methodName]||(this.prototype[methodName]=f.prototype[methodName]);for(a in f)this[a]||(this[a]=a)};return d}})();
(function(){Basic.EventPublisher=Basic.Class.extend({eventList:{},getEventCallbacks:function(b){if(this.eventList[b])return this.eventList[b];return false},on:function(b,c){var a=this.getEventCallbacks.call(this,b);a||(a=this.eventList[b]=[]);Basic.Array.indexOf(a,c)==-1&&a.push(c)},detach:function(b,c){var a=this.getEventCallbacks.call(this,b);if(a){var d=Basic.Array.indexOf(a,c);if(d>=0){a.splice(d,1);return true}}return false},fire:function(b,c){var a=this.getEventCallbacks.call(this,b);if(a&&
a.length>0)for(var d=0;d<a.length;d++)a[d](c)}})})();
var Handshake=Handshake||{};
(function(){Handshake.Communicator=Basic.Class.extend({init:function(b,a,c){this.serverIp=b;this.port=a;this.requestString=c;this.websocketStates={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}},connect:function(){if(!this.websocket||this.websocket&&this.websocket.readyState==this.websocketStates.CLOSED){this.websocket=new WebSocket("ws://"+this.serverIp+":"+this.port+"/"+this.requestString);var b=this;this.websocket.onopen=function(a){b.fire("websocketOpen",a)};this.websocket.onclose=function(a){b.fire("websocketClose",
a)};this.websocket.onerror=function(a){b.fire("websocketError",a)};this.websocket.onmessage=function(a){b.messageHandler(a)};return true}return false},disconnect:function(){this.websocket.readyState==this.websocketStates.OPEN&&this.websocket.close()},send:function(b,a,c){this.websocket.send(b+" "+a+(c?" "+JSON.stringify(c):""))},connectionStatus:function(){return this.websocket.readyState},isConnected:function(){if(this.connectionStatus==this.websocketStates.OPEN)return true;return false},messageHandler:function(b){b=
b.data;var a=b.match(/(\w*) (\w*) *(.*)/);if(a){var c=a[1];b=a[2];if((a=a[3])&&a!="")var d=JSON.parse(a);this.fire(b,{sender:c,data:d})}}});Handshake.Communicator.augment(Basic.EventPublisher)})();
(function(){function e(a){this.getClient(a.id)||(this.clientList[a.id]=a)}function f(a){if(this.getClient(a))this.clientList[a]=undefined}Handshake.Host=Handshake.Communicator.extend({init:function(a,d){this.superclass(a,d,"host");this.clientList={};var c=this;this.on("connect",function(b){if(b.sender=="server"){c.id=b.data.id;c.fire("selfReady",c.id)}else{b=new g(b.sender,b.data.deviceType,c);e.call(c,b);c.fire("clientConnect",b)}});this.on("disconnect",function(b){if(b.sender!="server")(b=c.getClient(b.sender))&&
c.fire("clientDisconnect",b)});this.on("websocketClose",function(b){c.fire("selfDisconnect",b)});this.on("exception",function(b){b.sender=="server"?c.fire("serverException",b.data):c.fire("clientException",b)})},getClient:function(a){if(this.clientList[a])return this.clientList[a]},disconnectClient:function(a,d){if(this.getClient(a)){send(a,"disconnected",d);f(a)}}});var g=Basic.Class.extend({init:function(a,d,c){this.id=a;this.deviceType=d;this.host=c},send:function(a,d){this.host.send(id,a,d)},
disconnect:function(a){this.host.disconnectClient(id,a)}})})();
(function(){Handshake.Client=Handshake.Communicator.extend({init:function(c,d,e){this.superclass(c,d,e+"/connect/webclient");this.gameId=e;var b=this;this.on("connect",function(a){if(a.sender=="server"){b.id=a.data;b.fire("selfReady",b.id)}});this.on("websocketClose",function(a){b.fire("selfDisconnect",a)});this.on("exception",function(a){a.sender=="server"?b.fire("serverException",a):b.fire("hostException",a)})},sendToHost:function(c,d){this.send("host",c,d)}})})();
